<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Soccer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;background:#1a4a1a;font-family:Arial,Helvetica,sans-serif;touch-action:none;user-select:none;-webkit-user-select:none;}
#game-wrap{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
canvas{display:block;}
#hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:center;align-items:center;padding:6px 12px;gap:16px;font-size:16px;font-weight:bold;color:#fff;text-shadow:1px 1px 3px rgba(0,0,0,0.7);z-index:5;pointer-events:none;}
#hud .score{font-size:20px;}
#hud .clock{font-size:14px;background:rgba(0,0,0,0.5);padding:2px 10px;border-radius:10px;}
#hud .half-label{font-size:11px;opacity:0.8;}
#controls{position:absolute;bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-end;padding:10px;z-index:10;pointer-events:none;}
#joystick-area{position:relative;width:120px;height:120px;pointer-events:auto;}
#joy-outer{width:120px;height:120px;border-radius:50%;border:2px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.05);position:absolute;top:0;left:0;}
#joy-inner{width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,0.2);position:absolute;top:36px;left:36px;transition:none;}
#buttons{display:flex;gap:10px;pointer-events:auto;}
.action-btn{width:64px;height:64px;border-radius:50%;border:2px solid;font-size:11px;font-weight:bold;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;text-shadow:1px 1px 2px rgba(0,0,0,0.5);transition:opacity 0.1s;}
#btn-pass{background:rgba(30,100,255,0.35);border-color:rgba(30,100,255,0.6);opacity:0.5;}
#btn-pass:active,#btn-pass.pressed{opacity:0.85;background:rgba(30,100,255,0.6);}
#btn-shoot{background:rgba(255,60,30,0.35);border-color:rgba(255,60,30,0.6);opacity:0.5;}
#btn-shoot:active,#btn-shoot.pressed{opacity:0.85;background:rgba(255,60,30,0.6);}
#overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:20;color:#fff;font-family:Arial,sans-serif;text-align:center;padding:20px;}
#overlay.show{display:flex;}
#overlay .big{font-size:36px;font-weight:bold;margin:8px 0;}
#overlay .med{font-size:20px;margin:6px 0;}
#overlay .small{font-size:14px;margin:4px 0;opacity:0.8;}
#overlay .btn{background:rgba(0,200,0,0.3);border:2px solid #0c0;color:#0c0;padding:12px 32px;font-size:16px;font-weight:bold;cursor:pointer;border-radius:8px;margin-top:16px;font-family:inherit;}
#overlay .btn:active{background:rgba(0,200,0,0.5);}
</style>
</head>
<body>
<div id="game-wrap">
  <canvas id="c"></canvas>
  <div id="hud">
    <span class="score" id="score-blue" style="color:#4af;">0</span>
    <div style="text-align:center;">
      <div class="clock" id="clock">2:00</div>
      <div class="half-label" id="half-label">1ST HALF</div>
    </div>
    <span class="score" id="score-red" style="color:#f55;">0</span>
  </div>
  <div id="controls">
    <div id="joystick-area">
      <div id="joy-outer"></div>
      <div id="joy-inner"></div>
    </div>
    <div id="buttons">
      <button class="action-btn" id="btn-pass">PASS</button>
      <button class="action-btn" id="btn-shoot">SHOOT</button>
    </div>
  </div>
  <div id="overlay"></div>
</div>

<script>
(function(){'use strict';

// ═══ AUDIO ═══
var ac=null;
function ensureAudio(){if(!ac)try{ac=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}if(ac&&ac.state==='suspended')ac.resume();}
function tone(f,d,v,type,sw){if(!ac)return;var o=ac.createOscillator(),g=ac.createGain();o.type=type||'square';o.frequency.setValueAtTime(f,ac.currentTime);if(sw)o.frequency.linearRampToValueAtTime(sw,ac.currentTime+d);g.gain.setValueAtTime(v||0.1,ac.currentTime);g.gain.linearRampToValueAtTime(0,ac.currentTime+d);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+d);}
function noise(d,v){if(!ac)return;var buf=ac.createBuffer(1,ac.sampleRate*d,ac.sampleRate);var data=buf.getChannelData(0);for(var i=0;i<data.length;i++)data[i]=(Math.random()*2-1);var src=ac.createBufferSource();src.buffer=buf;var g=ac.createGain();g.gain.setValueAtTime(v||0.1,ac.currentTime);g.gain.linearRampToValueAtTime(0,ac.currentTime+d);src.connect(g);g.connect(ac.destination);src.start();}
function sndKick(){tone(200,0.08,0.15,'sawtooth',100);}
function sndShoot(){tone(180,0.12,0.2,'sawtooth',80);}
function sndGoalPost(){tone(800,0.1,0.1,'sine',600);tone(100,0.15,0.08,'square');}
function sndGoal(){noise(0.4,0.25);tone(200,0.5,0.15,'sine',600);setTimeout(function(){noise(0.8,0.15);tone(400,0.8,0.1,'sine',500);},300);}
function sndWhistle(){tone(2000,0.15,0.12,'sine',1800);setTimeout(function(){tone(2000,0.25,0.12,'sine',1800);},200);}
function sndTackle(){noise(0.05,0.12);tone(120,0.05,0.08,'square');}

// ═══ GAME CONFIG ═══
var HALF_DURATION=120; // 2 minutes in seconds (120)
var FIELD_W=600,FIELD_H=900; // logical field size (portrait)
var GOAL_W=120,GOAL_D=30;
var PLAYER_R=10,BALL_R=6;
var PLAYER_SPEED=160,AI_SPEED=140,BALL_FRICTION=0.985,PASS_SPEED=320,SHOOT_SPEED=480;
var TACKLE_DIST=20,TACKLE_CHANCE=0.4;

// ═══ STATE ═══
var ST={START:0,PLAY:1,GOAL:2,HALFTIME:3,FULLTIME:4};
var state,half,clock,scoreBlue,scoreRed;
var players,ball,particles,confetti;
var humanIdx=0; // index in blue team
var goalTimer,halfTimer,celebPlayer;
var halftimeAnimTime=0,halftimeParticles=[],halftimeBallTrailPts=[];
var lastTime,dt;
var canvas,ctx,overlay;
var joyX=0,joyY=0,joyActive=false;
var passPressed=false,shootPressed=false;
var S; // scale factor
var portrait=true;

// ═══ DOM ═══
canvas=document.getElementById('c');
ctx=canvas.getContext('2d');
overlay=document.getElementById('overlay');

// ═══ RESIZE ═══
function resize(){
  var w=window.innerWidth,h=window.innerHeight;
  portrait=h>w;
  if(portrait){
    FIELD_W=600;FIELD_H=900;
  }else{
    FIELD_W=900;FIELD_H=600;
  }
  var scaleX=w/FIELD_W,scaleY=h/FIELD_H;
  S=Math.min(scaleX,scaleY);
  canvas.width=FIELD_W*S;
  canvas.height=FIELD_H*S;
  canvas.style.width=canvas.width+'px';
  canvas.style.height=canvas.height+'px';
}

// ═══ INIT ═══
function initGame(){
  scoreBlue=0;scoreRed=0;half=1;clock=HALF_DURATION;
  goalTimer=0;halfTimer=0;celebPlayer=null;
  particles=[];confetti=[];
  initPlayers(false);
  initBall();
}
function initPlayers(swapped){
  players=[];
  // Blue team (0-4), Red team (5-9)
  // Positions in field coords. Attack direction: portrait=up, landscape=right
  var blueAtk=swapped?1:-1; // -1 = attacks upward/left, 1 = attacks downward/right
  var formations=portrait?getFormationV(blueAtk):getFormationH(blueAtk);
  for(var i=0;i<10;i++){
    var f=formations[i];
    players.push({x:f.x,y:f.y,vx:0,vy:0,team:i<5?0:1,num:i<5?i+1:i-4,hasBall:false,isGK:f.gk||false,
      celebTimer:0,celebPhase:0,baseX:f.x,baseY:f.y});
  }
  humanIdx=2; // control an outfield player (#3)
  // Give ball to blue kickoff player
  players[humanIdx].hasBall=true;
  ball.x=players[humanIdx].x;ball.y=players[humanIdx].y;ball.vx=0;ball.vy=0;ball.free=false;ball.owner=humanIdx;
}
function getFormationV(dir){
  // dir: -1=attack up, 1=attack down
  var cy=FIELD_H/2;
  // GK stands IN FRONT of the goal (field side of goal line), not inside it
  var GK_OFF=GOAL_D+PLAYER_R+4;
  var gkY=dir<0?FIELD_H-GK_OFF:GK_OFF;
  var atkY=dir<0?FIELD_H*0.25:FIELD_H*0.75;
  var midY=cy;
  var defY=dir<0?FIELD_H*0.7:FIELD_H*0.3;
  // Blue: GK, DEF-L, MID(human), MID-R, FWD
  // Red: GK, DEF-L, MID, MID-R, FWD
  var oppGK=dir<0?GK_OFF:FIELD_H-GK_OFF;
  var oppAtk=dir<0?FIELD_H*0.75:FIELD_H*0.25;
  var oppMid=cy;
  var oppDef=dir<0?FIELD_H*0.3:FIELD_H*0.7;
  return[
    {x:FIELD_W/2,y:gkY,gk:true},
    {x:FIELD_W*0.3,y:defY},{x:FIELD_W/2,y:midY},{x:FIELD_W*0.7,y:midY},
    {x:FIELD_W/2,y:atkY},
    {x:FIELD_W/2,y:oppGK,gk:true},
    {x:FIELD_W*0.3,y:oppDef},{x:FIELD_W/2,y:oppMid},{x:FIELD_W*0.7,y:oppMid},
    {x:FIELD_W/2,y:oppAtk}
  ];
}
function getFormationH(dir){
  var cx=FIELD_W/2;
  // GK stands IN FRONT of the goal (field side of goal line), not inside it
  var GK_OFF=GOAL_D+PLAYER_R+4;
  var gkX=dir<0?FIELD_W-GK_OFF:GK_OFF;
  var atkX=dir<0?FIELD_W*0.25:FIELD_W*0.75;
  var midX=cx;
  var defX=dir<0?FIELD_W*0.7:FIELD_W*0.3;
  var oppGK=dir<0?GK_OFF:FIELD_W-GK_OFF;
  var oppAtk=dir<0?FIELD_W*0.75:FIELD_W*0.25;
  var oppMid=cx;
  var oppDef=dir<0?FIELD_W*0.3:FIELD_W*0.7;
  return[
    {x:gkX,y:FIELD_H/2,gk:true},
    {x:defX,y:FIELD_H*0.3},{x:midX,y:FIELD_H/2},{x:midX,y:FIELD_H*0.7},
    {x:atkX,y:FIELD_H/2},
    {x:oppGK,y:FIELD_H/2,gk:true},
    {x:oppDef,y:FIELD_H*0.3},{x:oppMid,y:FIELD_H/2},{x:oppMid,y:FIELD_H*0.7},
    {x:oppAtk,y:FIELD_H/2}
  ];
}
function initBall(){
  ball={x:FIELD_W/2,y:FIELD_H/2,vx:0,vy:0,free:false,owner:-1,trail:[],lastOwner:-1,lastOwnerTimer:0};
}

// ═══ GOAL DETECTION ═══
function getGoalAreas(){
  // Returns {blue: attacking goal, red: attacking goal}
  var swapped=(half===2);
  if(portrait){
    // Blue attacks up (half1) or down (half2)
    var blueGoal=swapped?{x:FIELD_W/2-GOAL_W/2,y:FIELD_H-GOAL_D,w:GOAL_W,h:GOAL_D,side:'bottom'}
                        :{x:FIELD_W/2-GOAL_W/2,y:0,w:GOAL_W,h:GOAL_D,side:'top'};
    var redGoal=swapped?{x:FIELD_W/2-GOAL_W/2,y:0,w:GOAL_W,h:GOAL_D,side:'top'}
                       :{x:FIELD_W/2-GOAL_W/2,y:FIELD_H-GOAL_D,w:GOAL_W,h:GOAL_D,side:'bottom'};
    return{blueTarget:blueGoal,redTarget:redGoal};
  }else{
    var blueGoal=swapped?{x:FIELD_W-GOAL_D,y:FIELD_H/2-GOAL_W/2,w:GOAL_D,h:GOAL_W,side:'right'}
                        :{x:0,y:FIELD_H/2-GOAL_W/2,w:GOAL_D,h:GOAL_W,side:'left'};
    var redGoal=swapped?{x:0,y:FIELD_H/2-GOAL_W/2,w:GOAL_D,h:GOAL_W,side:'left'}
                       :{x:FIELD_W-GOAL_D,y:FIELD_H/2-GOAL_W/2,w:GOAL_D,h:GOAL_W,side:'right'};
    return{blueTarget:blueGoal,redTarget:redGoal};
  }
}
function goalCenter(goal){
  return{x:goal.x+goal.w/2,y:goal.y+goal.h/2};
}

// ═══ UPDATE ═══
function update(){
  if(state!==ST.PLAY&&state!==ST.GOAL)return;
  if(state===ST.GOAL){
    goalTimer-=dt;
    updateCelebration();
    updateParticles();
    if(goalTimer<=0){resetAfterGoal();}
    return;
  }
  // Clock
  clock-=dt;
  if(clock<=0){
    clock=0;
    if(half===1){startHalftime();}
    else{startFulltime();}
    return;
  }
  updateHumanPlayer();
  updateAIPlayers();
  updateBall();
  checkGKIntercept(); // GK interception after ball moves, BEFORE goal detection
  checkTackles();
  checkGoals();
  updateParticles();
}

function updateHumanPlayer(){
  var p=players[humanIdx];
  var speed=PLAYER_SPEED;
  p.vx=joyX*speed;p.vy=joyY*speed;
  p.x+=p.vx*dt;p.y+=p.vy*dt;
  p.x=clamp(p.x,PLAYER_R,FIELD_W-PLAYER_R);
  p.y=clamp(p.y,PLAYER_R,FIELD_H-PLAYER_R);
  if(ball.owner===humanIdx){
    ball.x=p.x;ball.y=p.y;ball.vx=0;ball.vy=0;
  }
  // Pass
  if(passPressed){
    passPressed=false;
    if(ball.owner===humanIdx){doPass(humanIdx);}
    else{/* sprint toward ball */}
  }
  // Shoot
  if(shootPressed){
    shootPressed=false;
    if(ball.owner===humanIdx){doShoot(humanIdx);}
  }
}

function doPass(pi){
  var p=players[pi];
  // Find nearest teammate in facing direction
  var best=null,bestDist=Infinity;
  var team=p.team;
  for(var i=0;i<players.length;i++){
    if(i===pi)continue;
    if(players[i].team!==team)continue;
    var dx=players[i].x-p.x,dy=players[i].y-p.y;
    var d=Math.sqrt(dx*dx+dy*dy);
    // Prefer players roughly in direction of movement or forward
    if(d<bestDist&&d>30){bestDist=d;best=i;}
  }
  if(best!==null){
    var dx=players[best].x-p.x,dy=players[best].y-p.y;
    var d=Math.sqrt(dx*dx+dy*dy);
    ball.vx=(dx/d)*PASS_SPEED;ball.vy=(dy/d)*PASS_SPEED;
  }else{
    // Kick forward
    var dir=getAtkDir(team);
    ball.vx=dir.x*PASS_SPEED;ball.vy=dir.y*PASS_SPEED;
  }
  ball.free=true;ball.owner=-1;p.hasBall=false;
  sndKick();
}
function doShoot(pi){
  var p=players[pi];
  var goals=getGoalAreas();
  var target=p.team===0?goalCenter(goals.blueTarget):goalCenter(goals.redTarget);
  var dx=target.x-p.x,dy=target.y-p.y;
  var d=Math.sqrt(dx*dx+dy*dy)||1;
  // Add slight random spread
  var spread=(Math.random()-0.5)*40;
  ball.vx=(dx/d)*SHOOT_SPEED+spread;
  ball.vy=(dy/d)*SHOOT_SPEED+spread;
  ball.free=true;ball.owner=-1;p.hasBall=false;
  sndShoot();
}
function getAtkDir(team){
  var swapped=(half===2);
  if(portrait){return team===0?(swapped?{x:0,y:1}:{x:0,y:-1}):(swapped?{x:0,y:-1}:{x:0,y:1});}
  else{return team===0?(swapped?{x:-1,y:0}:{x:1,y:0}):(swapped?{x:1,y:0}:{x:-1,y:0});}
}

function updateAIPlayers(){
  for(var i=0;i<players.length;i++){
    if(i===humanIdx)continue;
    var p=players[i];
    if(p.isGK){updateGK(i);continue;}
    if(p.team===0)updateBlueAI(i);
    else updateRedAI(i);
    p.x=clamp(p.x,PLAYER_R,FIELD_W-PLAYER_R);
    p.y=clamp(p.y,PLAYER_R,FIELD_H-PLAYER_R);
  }
}
function updateGK(i){
  var p=players[i];
  var goals=getGoalAreas();
  var myGoal=p.team===0?goals.redTarget:goals.blueTarget;
  var gc=goalCenter(myGoal);

  // GK stands IN FRONT of the goal (on the field side of the goal line), not inside it.
  // This way when the GK intercepts the ball, it hasn't crossed the goal line yet.
  var GK_OFFSET=GOAL_D+PLAYER_R+4; // distance from the edge of the field to GK position
  if(portrait){
    var gkHomeY=myGoal.side==='top'?GK_OFFSET:FIELD_H-GK_OFFSET;
  }else{
    var gkHomeX=myGoal.side==='left'?GK_OFFSET:FIELD_W-GK_OFFSET;
  }

  // If GK has the ball, hold briefly then pass to a teammate (or kick to center)
  if(ball.owner===i){
    p.hasBall=true;
    ball.x=p.x;ball.y=p.y;ball.vx=0;ball.vy=0;
    if(!p.gkHoldTimer)p.gkHoldTimer=0;
    p.gkHoldTimer+=dt;
    if(p.gkHoldTimer>0.6){
      p.gkHoldTimer=0;
      // Find nearest teammate (not the GK itself)
      var best=null,bestDist=Infinity;
      for(var j=0;j<players.length;j++){
        if(j===i)continue;
        if(players[j].team!==p.team)continue;
        var tdx=players[j].x-p.x,tdy=players[j].y-p.y;
        var td=Math.sqrt(tdx*tdx+tdy*tdy);
        if(td>30&&td<bestDist){bestDist=td;best=j;}
      }
      var tx,ty;
      if(best!==null){
        tx=players[best].x;ty=players[best].y;
      }else{
        // Fallback: kick toward center of the pitch
        tx=FIELD_W/2;ty=FIELD_H/2;
      }
      var pdx=tx-p.x,pdy=ty-p.y;
      var pd=Math.sqrt(pdx*pdx+pdy*pdy)||1;
      ball.vx=(pdx/pd)*PASS_SPEED;
      ball.vy=(pdy/pd)*PASS_SPEED;
      // Offset ball from GK so it doesn't get immediately re-picked up
      ball.x=p.x+(pdx/pd)*(PLAYER_R+BALL_R+6);
      ball.y=p.y+(pdy/pd)*(PLAYER_R+BALL_R+6);
      ball.free=true;ball.owner=-1;p.hasBall=false;
      ball.lastOwner=i;ball.lastOwnerTimer=0.3;
      sndKick();
    }
    return;
  }
  p.gkHoldTimer=0;

  // Try to intercept ball if it's free and heading toward goal
  // Skip if this GK just passed the ball (cooldown prevents immediate re-catch)
  if(ball.free&&!(ball.lastOwnerTimer>0&&ball.lastOwner===i)){
    var bdx=ball.x-p.x,bdy=ball.y-p.y;
    var bd=Math.sqrt(bdx*bdx+bdy*bdy);
    if(bd<PLAYER_R+BALL_R+18){
      // GK catches the ball
      ball.free=false;ball.owner=i;p.hasBall=true;
      ball.vx=0;ball.vy=0;ball.x=p.x;ball.y=p.y;
      sndTackle();
      return;
    }
  }

  // Track ball position — GK stays in front of the goal, not inside it
  if(portrait){
    var targetX=clamp(ball.x,gc.x-GOAL_W/2+10,gc.x+GOAL_W/2-10);
    var dx=targetX-p.x,dy=gkHomeY-p.y;
    p.x+=clamp(dx,-AI_SPEED*dt*1.5,AI_SPEED*dt*1.5);
    p.y+=clamp(dy,-AI_SPEED*dt*0.5,AI_SPEED*dt*0.5);
  }else{
    var targetY=clamp(ball.y,gc.y-GOAL_W/2+10,gc.y+GOAL_W/2-10);
    var dx=gkHomeX-p.x,dy=targetY-p.y;
    p.x+=clamp(dx,-AI_SPEED*dt*0.5,AI_SPEED*dt*0.5);
    p.y+=clamp(dy,-AI_SPEED*dt*1.5,AI_SPEED*dt*1.5);
  }
}
function checkGKIntercept(){
  // Extra GK interception pass after ball movement, before goal detection.
  // This ensures that if the ball moved close to a GK during updateBall(),
  // the GK catches it before checkGoals() can fire.
  if(!ball.free)return;
  for(var i=0;i<players.length;i++){
    // Skip the GK that just passed the ball (cooldown prevents immediate re-catch)
    if(ball.lastOwnerTimer>0&&i===ball.lastOwner)continue;
    var p=players[i];
    if(!p.isGK)continue;
    var bdx=ball.x-p.x,bdy=ball.y-p.y;
    var bd=Math.sqrt(bdx*bdx+bdy*bdy);
    if(bd<PLAYER_R+BALL_R+18){
      ball.free=false;ball.owner=i;p.hasBall=true;
      ball.vx=0;ball.vy=0;ball.x=p.x;ball.y=p.y;
      sndTackle();
      return;
    }
  }
}
function updateBlueAI(i){
  var p=players[i];
  var speed=AI_SPEED;
  if(ball.owner===i){
    // Has ball — pass to human or shoot
    var hp=players[humanIdx];
    var dx=hp.x-p.x,dy=hp.y-p.y;
    var d=Math.sqrt(dx*dx+dy*dy);
    if(d<200&&Math.random()<0.02){doPass(i);return;}
    var goals=getGoalAreas();
    var gc=goalCenter(goals.blueTarget);
    var gd=Math.sqrt((gc.x-p.x)*(gc.x-p.x)+(gc.y-p.y)*(gc.y-p.y));
    if(gd<250&&Math.random()<0.03){doShoot(i);return;}
    // Dribble toward goal
    var dir=getAtkDir(0);
    p.x+=dir.x*speed*0.7*dt;p.y+=dir.y*speed*0.7*dt;
    ball.x=p.x;ball.y=p.y;
  }else{
    // Move to support position
    var dir=getAtkDir(0);
    var tx=p.baseX+dir.x*80+(Math.sin(clock*0.5+i)*40);
    var ty=p.baseY+dir.y*80+(Math.cos(clock*0.7+i)*40);
    // If ball is free and close, go for it
    if(ball.free){
      var bd=Math.sqrt((ball.x-p.x)*(ball.x-p.x)+(ball.y-p.y)*(ball.y-p.y));
      if(bd<150){tx=ball.x;ty=ball.y;}
    }
    var dx=tx-p.x,dy=ty-p.y;
    var d=Math.sqrt(dx*dx+dy*dy)||1;
    if(d>5){p.x+=(dx/d)*speed*dt;p.y+=(dy/d)*speed*dt;}
  }
}
function updateRedAI(i){
  var p=players[i];
  var speed=AI_SPEED*(half===2?1.08:1);
  if(ball.owner===i){
    // Has ball — dribble toward blue goal and shoot
    var goals=getGoalAreas();
    var gc=goalCenter(goals.redTarget);
    var dx=gc.x-p.x,dy=gc.y-p.y;
    var d=Math.sqrt(dx*dx+dy*dy)||1;
    if(d<220&&Math.random()<0.025){doShoot(i);return;}
    // Pass to teammate occasionally
    if(Math.random()<0.01){doPass(i);return;}
    p.x+=(dx/d)*speed*0.6*dt;p.y+=(dy/d)*speed*0.6*dt;
    ball.x=p.x;ball.y=p.y;
  }else{
    var tx,ty;
    // One player marks the human
    if(i===6){
      tx=players[humanIdx].x;ty=players[humanIdx].y;
    }else if(ball.free){
      var bd=Math.sqrt((ball.x-p.x)*(ball.x-p.x)+(ball.y-p.y)*(ball.y-p.y));
      if(bd<180){tx=ball.x;ty=ball.y;}
      else{tx=p.baseX+Math.sin(clock*0.4+i)*50;ty=p.baseY+Math.cos(clock*0.6+i)*50;}
    }else{
      tx=p.baseX+Math.sin(clock*0.4+i)*50;ty=p.baseY+Math.cos(clock*0.6+i)*50;
    }
    var dx=(tx||p.x)-p.x,dy=(ty||p.y)-p.y;
    var d=Math.sqrt(dx*dx+dy*dy)||1;
    if(d>5){p.x+=(dx/d)*speed*dt;p.y+=(dy/d)*speed*dt;}
  }
}

function updateBall(){
  if(!ball.free)return;
  // Decrement last-owner cooldown (prevents passer from immediately re-picking up the ball)
  if(ball.lastOwnerTimer>0)ball.lastOwnerTimer-=dt;
  ball.x+=ball.vx*dt;ball.y+=ball.vy*dt;
  ball.vx*=Math.pow(BALL_FRICTION,dt*60);
  ball.vy*=Math.pow(BALL_FRICTION,dt*60);
  // Trail
  if(Math.abs(ball.vx)>20||Math.abs(ball.vy)>20){
    ball.trail.push({x:ball.x,y:ball.y,life:0.3});
  }
  for(var i=ball.trail.length-1;i>=0;i--){ball.trail[i].life-=dt;if(ball.trail[i].life<=0)ball.trail.splice(i,1);}
  // Boundaries
  if(ball.x<BALL_R){ball.x=BALL_R;ball.vx=Math.abs(ball.vx)*0.6;}
  if(ball.x>FIELD_W-BALL_R){ball.x=FIELD_W-BALL_R;ball.vx=-Math.abs(ball.vx)*0.6;}
  if(ball.y<BALL_R){ball.y=BALL_R;ball.vy=Math.abs(ball.vy)*0.6;}
  if(ball.y>FIELD_H-BALL_R){ball.y=FIELD_H-BALL_R;ball.vy=-Math.abs(ball.vy)*0.6;}
  // Pick up by nearest player
  var spd=Math.sqrt(ball.vx*ball.vx+ball.vy*ball.vy);
  if(spd<200){
    for(var i=0;i<players.length;i++){
      // Skip the last owner during cooldown so the passer doesn't recapture instantly
      if(ball.lastOwnerTimer>0&&i===ball.lastOwner)continue;
      var p=players[i];
      var dx=p.x-ball.x,dy=p.y-ball.y;
      var d=Math.sqrt(dx*dx+dy*dy);
      // Human player has a much larger pickup radius for easier ball control
      var pickupRadius=(i===humanIdx)?PLAYER_R+BALL_R+30:PLAYER_R+BALL_R+4;
      if(d<pickupRadius){
        ball.free=false;ball.owner=i;p.hasBall=true;
        ball.vx=0;ball.vy=0;break;
      }
    }
  }
}
function checkTackles(){
  for(var i=0;i<players.length;i++){
    var p=players[i];
    if(!p.hasBall)continue;
    for(var j=0;j<players.length;j++){
      if(i===j||players[j].team===p.team)continue;
      var dx=players[j].x-p.x,dy=players[j].y-p.y;
      var d=Math.sqrt(dx*dx+dy*dy);
      if(d<TACKLE_DIST&&Math.random()<TACKLE_CHANCE*dt*2){
        // Tackle!
        p.hasBall=false;ball.free=true;ball.owner=-1;
        ball.vx=(Math.random()-0.5)*100;ball.vy=(Math.random()-0.5)*100;
        sndTackle();break;
      }
    }
  }
}
function checkGoals(){
  // Only count a goal if the ball is FREE (not held by any player, including GK)
  if(!ball.free)return;
  var goals=getGoalAreas();
  // Blue scores (ball in blue target)
  var bg=goals.blueTarget;
  if(ball.x>bg.x&&ball.x<bg.x+bg.w&&ball.y>bg.y&&ball.y<bg.y+bg.h){
    scoreBlue++;triggerGoal(0);return;
  }
  // Red scores
  var rg=goals.redTarget;
  if(ball.x>rg.x&&ball.x<rg.x+rg.w&&ball.y>rg.y&&ball.y<rg.y+rg.h){
    scoreRed++;triggerGoal(1);return;
  }
}
function triggerGoal(team){
  state=ST.GOAL;goalTimer=3;
  sndGoal();
  // Find scorer (last owner or closest player of scoring team)
  var scorerIdx=-1;
  for(var i=0;i<players.length;i++){if(players[i].team===team&&!players[i].isGK){scorerIdx=i;break;}}
  celebPlayer=scorerIdx;
  // Spawn confetti
  for(var i=0;i<60;i++){
    confetti.push({x:ball.x,y:ball.y,vx:(Math.random()-0.5)*300,vy:-Math.random()*400,
      life:2+Math.random(),color:team===0?'#4af':'#f55',size:3+Math.random()*4});
  }
  ball.free=false;ball.vx=0;ball.vy=0;
}
function updateCelebration(){
  if(celebPlayer>=0){
    var p=players[celebPlayer];
    p.celebTimer+=dt;p.celebPhase=Math.floor(p.celebTimer*6)%4;
  }
  // Update confetti
  for(var i=confetti.length-1;i>=0;i--){
    var c=confetti[i];c.x+=c.vx*dt;c.y+=c.vy*dt;c.vy+=500*dt;c.life-=dt;
    if(c.life<=0)confetti.splice(i,1);
  }
}
function updateParticles(){
  for(var i=particles.length-1;i>=0;i--){
    var p=particles[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;
    if(p.life<=0)particles.splice(i,1);
  }
}
function resetAfterGoal(){
  state=ST.PLAY;
  confetti=[];
  if(celebPlayer>=0)players[celebPlayer].celebTimer=0;
  celebPlayer=null;
  var swapped=(half===2);
  initPlayers(swapped);
  initBall();
  // Give ball to team that conceded (kickoff)
  var lastScorer=(scoreBlue+scoreRed)%2===0?0:1;
  players[humanIdx].hasBall=true;
  ball.owner=humanIdx;ball.free=false;
}

// ═══ HALFTIME / FULLTIME ═══
function startHalftime(){
  state=ST.HALFTIME;halfTimer=10;halftimeAnimTime=0;sndWhistle();
  // Initialize halftime particles and ball trail for the animation
  halftimeParticles=[];
  halftimeBallTrailPts=[];
  // Pre-generate the bouncing ball path (used in phase 2)
  for(var i=0;i<80;i++){
    var t=i/80;
    halftimeBallTrailPts.push({
      x:FIELD_W*0.1+t*FIELD_W*0.8,
      y:FIELD_H*0.55-Math.abs(Math.sin(t*Math.PI*4))*FIELD_H*0.15
    });
  }
}
function startFulltime(){
  state=ST.FULLTIME;sndWhistle();
  var msg=scoreBlue>scoreRed?'BLUE WINS!':scoreRed>scoreBlue?'RED WINS!':'DRAW!';
  showOverlay('<div class="big">FULL TIME</div><div class="med">'+scoreBlue+' — '+scoreRed+'</div><div class="big" style="font-size:28px;margin-top:12px;">'+msg+'</div><button class="btn" id="restart-btn">PLAY AGAIN</button>');
  setTimeout(function(){
    var btn=document.getElementById('restart-btn');
    if(btn)btn.addEventListener('click',function(){ensureAudio();hideOverlay();initGame();state=ST.PLAY;});
  },100);
}
function updateHalftime(){
  halfTimer-=dt;
  halftimeAnimTime+=dt;
  // Spawn ambient particles during the animation
  if(halftimeAnimTime<8&&Math.random()<0.3){
    var side=Math.random()<0.5?0:1;
    halftimeParticles.push({
      x:Math.random()*FIELD_W,y:Math.random()*FIELD_H,
      vx:(Math.random()-0.5)*30,vy:-Math.random()*20-10,
      life:1.5+Math.random()*1.5,maxLife:1.5+Math.random()*1.5,
      color:side===0?'#4af':'#f55',size:2+Math.random()*3
    });
  }
  // Update halftime particles
  for(var i=halftimeParticles.length-1;i>=0;i--){
    var p=halftimeParticles[i];
    p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;
    if(p.life<=0)halftimeParticles.splice(i,1);
  }
  if(halfTimer<=0){
    half=2;clock=HALF_DURATION;
    halftimeParticles=[];halftimeBallTrailPts=[];
    initPlayers(true);initBall();
    state=ST.PLAY;
  }
}
function drawHalftimeAnimation(){
  if(state!==ST.HALFTIME)return;
  var t=halftimeAnimTime;
  var cx=FIELD_W/2,cy=FIELD_H/2;

  // Dark overlay
  ctx.fillStyle='rgba(0,0,0,0.75)';
  ctx.fillRect(0,0,FIELD_W,FIELD_H);

  // Draw ambient particles (behind everything)
  for(var i=0;i<halftimeParticles.length;i++){
    var p=halftimeParticles[i];
    var alpha=p.life/p.maxLife*0.6;
    ctx.globalAlpha=alpha;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  // ── PHASE 1 (0-2s): "HALF TIME" zooms in + whistle visual + score ──
  if(t<2){
    var phase=t/2; // 0→1
    // Text zoom in with elastic ease
    var ease=phase<0.5?4*phase*phase*phase:1-Math.pow(-2*phase+2,3)/2;
    var scale=ease*1.0+0.05;
    // Whistle rings emanating from center
    var ringCount=3;
    for(var r=0;r<ringCount;r++){
      var rPhase=(t*2+r*0.4)%1.5;
      if(rPhase<1.2){
        var rAlpha=(1-rPhase/1.2)*0.3;
        var rSize=30+rPhase*80;
        ctx.strokeStyle='rgba(255,255,200,'+rAlpha+')';
        ctx.lineWidth=2;
        ctx.beginPath();ctx.arc(cx,cy-40,rSize,0,Math.PI*2);ctx.stroke();
      }
    }
    // "HALF TIME" text
    ctx.save();ctx.translate(cx,cy-20);ctx.scale(scale,scale);
    ctx.fillStyle='#fff';ctx.font='bold 48px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='#4af';ctx.shadowBlur=20;
    ctx.fillText('HALF TIME',0,0);
    ctx.shadowBlur=0;ctx.restore();
    // Score
    var scoreAlpha=Math.min(1,t/1);
    ctx.globalAlpha=scoreAlpha;
    ctx.font='bold 36px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillStyle='#4af';ctx.fillText(scoreBlue,cx-50,cy+45);
    ctx.fillStyle='#aaa';ctx.fillText('—',cx,cy+45);
    ctx.fillStyle='#f55';ctx.fillText(scoreRed,cx+50,cy+45);
    ctx.globalAlpha=1;
  }

  // ── PHASE 2 (2-5s): Bouncing ball + player silhouettes walking off ──
  else if(t<5){
    var phase=(t-2)/3; // 0→1
    // Draw score (persistent, top area)
    drawHalftimeScore(cx,cy);
    // Bouncing ball animation along the precomputed trail
    var ballIdx=Math.floor(phase*halftimeBallTrailPts.length);
    ballIdx=Math.min(ballIdx,halftimeBallTrailPts.length-1);
    // Draw trail behind the ball
    var trailStart=Math.max(0,ballIdx-20);
    for(var i=trailStart;i<ballIdx;i++){
      var tp=halftimeBallTrailPts[i];
      var trailAlpha=(i-trailStart)/(ballIdx-trailStart)*0.5;
      ctx.globalAlpha=trailAlpha;
      ctx.fillStyle='#fff';
      ctx.beginPath();ctx.arc(tp.x,tp.y,3,0,Math.PI*2);ctx.fill();
    }
    ctx.globalAlpha=1;
    // Draw the ball
    if(ballIdx>=0&&ballIdx<halftimeBallTrailPts.length){
      var bp=halftimeBallTrailPts[ballIdx];
      // Ball shadow
      ctx.fillStyle='rgba(0,0,0,0.3)';
      ctx.beginPath();ctx.ellipse(bp.x,FIELD_H*0.62,8,3,0,0,Math.PI*2);ctx.fill();
      // Ball
      ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(bp.x,bp.y,BALL_R+2,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#888';ctx.lineWidth=1;ctx.stroke();
      // Ball spin lines
      var angle=phase*Math.PI*8;
      ctx.strokeStyle='#aaa';ctx.lineWidth=0.8;
      ctx.beginPath();
      ctx.arc(bp.x,bp.y,BALL_R,angle,angle+Math.PI*0.6);ctx.stroke();
      ctx.beginPath();
      ctx.arc(bp.x,bp.y,BALL_R,angle+Math.PI,angle+Math.PI*1.6);ctx.stroke();
    }
    // Player silhouettes walking off pitch
    var numSilhouettes=6;
    for(var i=0;i<numSilhouettes;i++){
      var sx=FIELD_W*0.15+i*(FIELD_W*0.7/(numSilhouettes-1));
      var walkOff=phase*60; // how far they've walked
      var sy=FIELD_H*0.72+walkOff+(i%2)*8;
      var bobble=Math.sin(t*4+i*1.3)*2;
      var isBlue=i<3;
      ctx.globalAlpha=Math.max(0,1-phase*0.6);
      ctx.fillStyle=isBlue?'#2266ff':'#ee3333';
      // Body
      ctx.beginPath();ctx.arc(sx,sy+bobble,6,0,Math.PI*2);ctx.fill();
      // Legs (walking)
      ctx.strokeStyle=isBlue?'#2266ff':'#ee3333';ctx.lineWidth=2;
      var legSwing=Math.sin(t*6+i*2)*4;
      ctx.beginPath();ctx.moveTo(sx-2,sy+bobble+6);ctx.lineTo(sx-2+legSwing,sy+bobble+14);ctx.stroke();
      ctx.beginPath();ctx.moveTo(sx+2,sy+bobble+6);ctx.lineTo(sx+2-legSwing,sy+bobble+14);ctx.stroke();
    }
    ctx.globalAlpha=1;
  }

  // ── PHASE 3 (5-8s): Stats display with stylized replay trail ──
  else if(t<8){
    var phase=(t-5)/3; // 0→1
    drawHalftimeScore(cx,cy);
    // "Match Stats" header
    ctx.fillStyle='rgba(255,255,255,0.7)';ctx.font='bold 16px Arial';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('MATCH STATS',cx,cy-60);
    // Decorative line under header
    var lineW=100*Math.min(1,phase*3);
    ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(cx-lineW,cy-50);ctx.lineTo(cx+lineW,cy-50);ctx.stroke();
    // Stats bars (animated appearance)
    var stats=[
      {label:'Possession',blue:55,red:45},
      {label:'Shots',blue:Math.max(scoreBlue,1+Math.floor(Math.random()*0.01)),red:Math.max(scoreRed,1+Math.floor(Math.random()*0.01))},
      {label:'Passes',blue:12,red:10}
    ];
    for(var i=0;i<stats.length;i++){
      var reveal=Math.min(1,Math.max(0,(phase-i*0.15)*2));
      if(reveal<=0)continue;
      var sy=cy-25+i*40;
      ctx.globalAlpha=reveal;
      // Label
      ctx.fillStyle='#ccc';ctx.font='11px Arial';ctx.textAlign='center';
      ctx.fillText(stats[i].label,cx,sy-8);
      // Bar background
      var barW=160,barH=10,barX=cx-barW/2;
      ctx.fillStyle='rgba(255,255,255,0.1)';
      roundRect(ctx,barX,sy,barW,barH,3);ctx.fill();
      // Blue portion
      var total=stats[i].blue+stats[i].red;
      var blueW=(stats[i].blue/total)*barW*reveal;
      ctx.fillStyle='rgba(68,170,255,0.7)';
      roundRect(ctx,barX,sy,blueW,barH,3);ctx.fill();
      // Red portion (from right)
      var redW=(stats[i].red/total)*barW*reveal;
      ctx.fillStyle='rgba(255,85,85,0.7)';
      roundRect(ctx,barX+barW-redW,sy,redW,barH,3);ctx.fill();
      // Numbers
      ctx.fillStyle='#4af';ctx.font='bold 11px Arial';ctx.textAlign='right';
      ctx.fillText(stats[i].blue,barX-6,sy+9);
      ctx.fillStyle='#f55';ctx.textAlign='left';
      ctx.fillText(stats[i].red,barX+barW+6,sy+9);
    }
    ctx.globalAlpha=1;
    // Stylized ball movement replay (dotted trail pattern in background)
    var trailAlpha=0.15+Math.sin(t*2)*0.05;
    ctx.strokeStyle='rgba(255,255,255,'+trailAlpha+')';
    ctx.lineWidth=1;ctx.setLineDash([3,6]);
    ctx.beginPath();
    for(var i=0;i<halftimeBallTrailPts.length;i++){
      var tp=halftimeBallTrailPts[i];
      var offY=tp.y-FIELD_H*0.55+FIELD_H*0.78; // shift trail to bottom area
      if(i===0)ctx.moveTo(tp.x,offY);
      else ctx.lineTo(tp.x,offY);
    }
    ctx.stroke();ctx.setLineDash([]);
  }

  // ── PHASE 4 (8-10s): "SECOND HALF" + countdown 3..2..1 ──
  else{
    var phase=(t-8)/2; // 0→1
    drawHalftimeScore(cx,cy);
    // "SECOND HALF" text with glow
    var textAlpha=Math.min(1,phase*3);
    ctx.globalAlpha=textAlpha;
    ctx.save();ctx.translate(cx,cy-20);
    // Pulsing glow
    var glowSize=10+Math.sin(t*5)*5;
    ctx.shadowColor='#0f0';ctx.shadowBlur=glowSize;
    ctx.fillStyle='#fff';ctx.font='bold 40px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('SECOND HALF',0,0);
    ctx.shadowBlur=0;ctx.restore();
    // Countdown: 3...2...1...
    var countdownTime=phase*2; // 0→2 seconds
    var countNum=3-Math.floor(countdownTime*1.5);
    if(countNum>=1&&countNum<=3){
      var countPhase=(countdownTime*1.5)%1; // 0→1 within each count
      var countScale=1+countPhase*0.3;
      var countAlpha=1-countPhase*0.5;
      ctx.globalAlpha=countAlpha;
      ctx.save();ctx.translate(cx,cy+40);ctx.scale(countScale,countScale);
      ctx.fillStyle='#0c0';ctx.font='bold 52px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(countNum+'',0,0);
      ctx.restore();
      // Ring burst around the number
      ctx.strokeStyle='rgba(0,200,0,'+(countAlpha*0.4)+')';ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(cx,cy+40,30+countPhase*40,0,Math.PI*2);ctx.stroke();
    }
    ctx.globalAlpha=1;
  }
}
function drawHalftimeScore(cx,cy){
  // Compact score display in the upper portion
  ctx.fillStyle='#fff';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
  var scoreY=cy-90;
  ctx.fillStyle='#4af';ctx.fillText(scoreBlue,cx-35,scoreY);
  ctx.fillStyle='rgba(255,255,255,0.5)';ctx.fillText('—',cx,scoreY);
  ctx.fillStyle='#f55';ctx.fillText(scoreRed,cx+35,scoreY);
  // Team color dots
  ctx.fillStyle='#4af';ctx.beginPath();ctx.arc(cx-60,scoreY,5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#f55';ctx.beginPath();ctx.arc(cx+60,scoreY,5,0,Math.PI*2);ctx.fill();
}
function roundRect(c,x,y,w,h,r){
  c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath();
}

// ═══ DRAW ═══
function draw(){
  ctx.save();
  ctx.scale(S,S);
  drawField();
  drawGoals();
  drawBallTrail();
  drawPlayers();
  drawBall();
  drawConfetti();
  drawGoalText();
  if(state===ST.HALFTIME)drawHalftimeAnimation();
  ctx.restore();
  updateHUD();
}
function drawField(){
  // Pitch
  ctx.fillStyle='#2d7a2d';ctx.fillRect(0,0,FIELD_W,FIELD_H);
  // Stripes
  ctx.fillStyle='#2a722a';
  var stripeW=FIELD_W/8;
  for(var i=0;i<8;i+=2){ctx.fillRect(i*stripeW,0,stripeW,FIELD_H);}
  // Lines
  ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=1.5;
  ctx.strokeRect(10,10,FIELD_W-20,FIELD_H-20); // boundary
  // Center
  if(portrait){
    ctx.beginPath();ctx.moveTo(10,FIELD_H/2);ctx.lineTo(FIELD_W-10,FIELD_H/2);ctx.stroke();
    ctx.beginPath();ctx.arc(FIELD_W/2,FIELD_H/2,50,0,Math.PI*2);ctx.stroke();
    // Penalty areas
    ctx.strokeRect(FIELD_W/2-100,10,200,60);ctx.strokeRect(FIELD_W/2-100,FIELD_H-70,200,60);
    // Goal areas
    ctx.strokeRect(FIELD_W/2-50,10,100,30);ctx.strokeRect(FIELD_W/2-50,FIELD_H-40,100,30);
  }else{
    ctx.beginPath();ctx.moveTo(FIELD_W/2,10);ctx.lineTo(FIELD_W/2,FIELD_H-10);ctx.stroke();
    ctx.beginPath();ctx.arc(FIELD_W/2,FIELD_H/2,50,0,Math.PI*2);ctx.stroke();
    ctx.strokeRect(10,FIELD_H/2-100,60,200);ctx.strokeRect(FIELD_W-70,FIELD_H/2-100,60,200);
    ctx.strokeRect(10,FIELD_H/2-50,30,100);ctx.strokeRect(FIELD_W-40,FIELD_H/2-50,30,100);
  }
}
function drawGoals(){
  var goals=getGoalAreas();
  ctx.fillStyle='rgba(255,255,255,0.15)';
  var bg=goals.blueTarget,rg=goals.redTarget;
  ctx.fillRect(bg.x,bg.y,bg.w,bg.h);
  ctx.fillRect(rg.x,rg.y,rg.w,rg.h);
  ctx.strokeStyle='#fff';ctx.lineWidth=2;
  ctx.strokeRect(bg.x,bg.y,bg.w,bg.h);
  ctx.strokeRect(rg.x,rg.y,rg.w,rg.h);
  // Net lines
  ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=0.5;
  for(var i=0;i<5;i++){
    var t=i/4;
    if(bg.h>bg.w){ctx.beginPath();ctx.moveTo(bg.x,bg.y+bg.h*t);ctx.lineTo(bg.x+bg.w,bg.y+bg.h*t);ctx.stroke();}
    else{ctx.beginPath();ctx.moveTo(bg.x+bg.w*t,bg.y);ctx.lineTo(bg.x+bg.w*t,bg.y+bg.h);ctx.stroke();}
    if(rg.h>rg.w){ctx.beginPath();ctx.moveTo(rg.x,rg.y+rg.h*t);ctx.lineTo(rg.x+rg.w,rg.y+rg.h*t);ctx.stroke();}
    else{ctx.beginPath();ctx.moveTo(rg.x+rg.w*t,rg.y);ctx.lineTo(rg.x+rg.w*t,rg.y+rg.h);ctx.stroke();}
  }
}
function drawPlayers(){
  for(var i=0;i<players.length;i++){
    var p=players[i];
    var color=p.team===0?'#2266ff':'#ee3333';
    var r=PLAYER_R;
    // Celebration animation
    if(state===ST.GOAL&&i===celebPlayer){
      var phase=p.celebPhase;
      var bounceY=Math.sin(p.celebTimer*10)*5;
      ctx.save();ctx.translate(p.x,p.y+bounceY);
      // Arms up
      ctx.strokeStyle=color;ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(-6,-r);ctx.lineTo(-12,-r-10);ctx.stroke();
      ctx.beginPath();ctx.moveTo(6,-r);ctx.lineTo(12,-r-10);ctx.stroke();
      // Spinning star
      var angle=p.celebTimer*8;
      ctx.strokeStyle='#ff0';ctx.lineWidth=1;
      for(var s=0;s<5;s++){
        var a=angle+s*Math.PI*2/5;
        ctx.beginPath();ctx.moveTo(Math.cos(a)*16,Math.sin(a)*16);ctx.lineTo(Math.cos(a)*20,Math.sin(a)*20);ctx.stroke();
      }
      ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
      ctx.fillStyle='#fff';ctx.font='bold 8px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(p.num,0,0);
      ctx.restore();
      continue;
    }
    // Highlight human player
    if(i===humanIdx){
      ctx.beginPath();ctx.arc(p.x,p.y,r+4,0,Math.PI*2);
      ctx.strokeStyle='rgba(255,255,100,0.6)';ctx.lineWidth=2;ctx.stroke();
    }
    ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 8px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(p.num,p.x,p.y);
    // GK marker
    if(p.isGK){
      ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);
      ctx.strokeStyle='#ff0';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
}
function drawBall(){
  ctx.beginPath();ctx.arc(ball.x,ball.y,BALL_R,0,Math.PI*2);
  ctx.fillStyle='#fff';ctx.fill();
  ctx.strokeStyle='#888';ctx.lineWidth=1;ctx.stroke();
}
function drawBallTrail(){
  for(var i=0;i<ball.trail.length;i++){
    var t=ball.trail[i];
    ctx.beginPath();ctx.arc(t.x,t.y,2,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,'+(t.life*1.5)+')';ctx.fill();
  }
}
function drawConfetti(){
  for(var i=0;i<confetti.length;i++){
    var c=confetti[i];
    ctx.fillStyle=c.color;ctx.globalAlpha=Math.min(1,c.life);
    ctx.fillRect(c.x-c.size/2,c.y-c.size/2,c.size,c.size);
  }
  ctx.globalAlpha=1;
}
function drawGoalText(){
  if(state===ST.GOAL){
    var t=3-goalTimer;
    var scale=1+Math.sin(t*6)*0.15;
    ctx.save();
    ctx.translate(FIELD_W/2,FIELD_H/2);ctx.scale(scale,scale);
    ctx.fillStyle='#fff';ctx.font='bold 48px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='#000';ctx.shadowBlur=10;
    ctx.fillText('GOOOAL!',0,0);
    ctx.shadowBlur=0;
    ctx.restore();
  }
}
function updateHUD(){
  document.getElementById('score-blue').textContent=scoreBlue;
  document.getElementById('score-red').textContent=scoreRed;
  var mins=Math.floor(clock/60);var secs=Math.floor(clock%60);
  document.getElementById('clock').textContent=mins+':'+(secs<10?'0':'')+secs;
  document.getElementById('half-label').textContent=half===1?'1ST HALF':'2ND HALF';
}

// ═══ OVERLAY ═══
function showOverlay(html){overlay.innerHTML=html;overlay.classList.add('show');}
function hideOverlay(){overlay.classList.remove('show');overlay.innerHTML='';}

// ═══ INPUT ═══
function setupInput(){
  // Joystick
  var joyOuter=document.getElementById('joy-outer');
  var joyInner=document.getElementById('joy-inner');
  var joyArea=document.getElementById('joystick-area');
  var jCenterX=60,jCenterY=60,jRadius=36;
  function updateJoy(cx,cy){
    var dx=cx-jCenterX,dy=cy-jCenterY;
    var d=Math.sqrt(dx*dx+dy*dy);
    if(d>jRadius){dx=(dx/d)*jRadius;dy=(dy/d)*jRadius;}
    joyInner.style.left=(60-24+dx)+'px';joyInner.style.top=(60-24+dy)+'px';
    joyX=dx/jRadius;joyY=dy/jRadius;
    joyActive=true;
  }
  function resetJoy(){joyInner.style.left='36px';joyInner.style.top='36px';joyX=0;joyY=0;joyActive=false;}
  var joyTouchId=null;
  joyArea.addEventListener('touchstart',function(e){
    e.preventDefault();ensureAudio();
    var t=e.changedTouches[0];joyTouchId=t.identifier;
    var rect=joyArea.getBoundingClientRect();
    updateJoy(t.clientX-rect.left,t.clientY-rect.top);
  },{passive:false});
  joyArea.addEventListener('touchmove',function(e){
    e.preventDefault();
    for(var i=0;i<e.changedTouches.length;i++){
      if(e.changedTouches[i].identifier===joyTouchId){
        var t=e.changedTouches[i];var rect=joyArea.getBoundingClientRect();
        updateJoy(t.clientX-rect.left,t.clientY-rect.top);
      }
    }
  },{passive:false});
  joyArea.addEventListener('touchend',function(e){
    for(var i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===joyTouchId){resetJoy();joyTouchId=null;}}
  });
  // Mouse joystick
  var mouseDown=false;
  joyArea.addEventListener('mousedown',function(e){
    mouseDown=true;ensureAudio();
    var rect=joyArea.getBoundingClientRect();updateJoy(e.clientX-rect.left,e.clientY-rect.top);
  });
  document.addEventListener('mousemove',function(e){
    if(!mouseDown)return;
    var rect=joyArea.getBoundingClientRect();updateJoy(e.clientX-rect.left,e.clientY-rect.top);
  });
  document.addEventListener('mouseup',function(){if(mouseDown){mouseDown=false;resetJoy();}});

  // Buttons
  function btnHandler(id,cb){
    var btn=document.getElementById(id);
    btn.addEventListener('touchstart',function(e){e.preventDefault();ensureAudio();cb();},{passive:false});
    btn.addEventListener('mousedown',function(e){if(e.button===0){ensureAudio();cb();}});
  }
  btnHandler('btn-pass',function(){
    if(state===ST.START){initGame();state=ST.PLAY;hideOverlay();return;}
    if(state===ST.FULLTIME)return;
    passPressed=true;
  });
  btnHandler('btn-shoot',function(){
    if(state===ST.START){initGame();state=ST.PLAY;hideOverlay();return;}
    if(state===ST.FULLTIME)return;
    shootPressed=true;
  });

  // Keyboard
  var keys={};
  document.addEventListener('keydown',function(e){
    keys[e.key]=true;
    if(e.key==='Enter'){
      ensureAudio();
      if(state===ST.START){initGame();state=ST.PLAY;hideOverlay();}
      else if(state===ST.FULLTIME){initGame();state=ST.PLAY;hideOverlay();}
      else shootPressed=true;
      e.preventDefault();
    }
    if(e.key===' '){passPressed=true;e.preventDefault();}
    if(e.key==='Shift'){shootPressed=true;e.preventDefault();}
  });
  document.addEventListener('keyup',function(e){keys[e.key]=false;});
  // Keyboard movement
  setInterval(function(){
    if(joyActive)return;
    var kx=0,ky=0;
    if(keys['ArrowLeft']||keys['a'])kx=-1;
    if(keys['ArrowRight']||keys['d'])kx=1;
    if(keys['ArrowUp']||keys['w'])ky=-1;
    if(keys['ArrowDown']||keys['s'])ky=1;
    if(kx||ky){var d=Math.sqrt(kx*kx+ky*ky);joyX=kx/d;joyY=ky/d;}
    else{joyX=0;joyY=0;}
  },16);
}

// ═══ UTILITIES ═══
function clamp(v,lo,hi){return v<lo?lo:v>hi?hi:v;}

// ═══ GAME LOOP ═══
function loop(now){
  if(!lastTime)lastTime=now;
  dt=Math.min(0.05,(now-lastTime)/1000);
  lastTime=now;
  if(state===ST.HALFTIME)updateHalftime();
  else update();
  draw();
  requestAnimationFrame(loop);
}

// ═══ START ═══
function init(){
  resize();
  setupInput();
  window.addEventListener('resize',function(){resize();});
  state=ST.START;
  ball={x:0,y:0,vx:0,vy:0,free:false,owner:-1,trail:[],lastOwner:-1,lastOwnerTimer:0};
  players=[];particles=[];confetti=[];
  scoreBlue=0;scoreRed=0;half=1;clock=HALF_DURATION;
  showOverlay('<div class="big" style="color:#4f4;">⚽ SOCCER</div><div class="med">Dodge, Pass & Score!</div><div class="small">Move: Joystick / Arrow Keys<br>Pass: PASS button / Space<br>Shoot: SHOOT button / Enter</div><div class="small" style="margin-top:12px;">TAP or PRESS ENTER TO START</div>');
  lastTime=0;
  requestAnimationFrame(loop);
}
init();
})();
</script>
</body>
</html>
