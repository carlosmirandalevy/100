rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Submissions: public create, admin full access
    match /submissions/{docId} {
      allow create: if
        request.resource.data.status == 'pending'
        && request.resource.data.title is string
        && request.resource.data.title.size() > 0
        && request.resource.data.title.size() <= 200
        && request.resource.data.description is string
        && request.resource.data.description.size() > 0
        && request.resource.data.description.size() <= 2000
        && request.resource.data.type in ['item', 'dont', 'category', 'example', 'request', 'tips', 'skills', 'quickwins', 'showcase', 'tool', 'faq']
        && request.resource.data.category is string;
      allow read, update, delete: if
        request.auth != null
        && request.auth.uid == 'j10SieMUNeMJMtJGHWPUSYqvO8G3';
    }

    // Likes: public read, public like/unlike (+1 or -1), admin full access
    match /likes/{itemId} {
      allow read: if true;
      allow create: if
        request.resource.data.count == 1;
      allow update: if
        request.resource.data.count == resource.data.count + 1
        || request.resource.data.count == resource.data.count - 1;
      allow read, write: if
        request.auth != null
        && request.auth.uid == 'j10SieMUNeMJMtJGHWPUSYqvO8G3';
    }

    // Newsletter: public create only, admin read access
    match /newsletter/{docId} {
      allow create: if
        request.resource.data.email is string
        && request.resource.data.email.size() > 0
        && request.resource.data.email.size() <= 320
        && request.resource.data.language is string
        && request.resource.data.page is string
        && request.resource.data.keys().hasAll(['email', 'language', 'page', 'subscribedAt']);
      allow read, update, delete: if
        request.auth != null
        && request.auth.uid == 'j10SieMUNeMJMtJGHWPUSYqvO8G3';
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
